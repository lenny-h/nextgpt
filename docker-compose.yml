# Docker Compose configuration for local development
# Includes PostgreSQL with pgvector extension, Redis, and MinIO
# See DOCKER_SETUP.md for detailed documentation

name: mono

services:
  # PostgreSQL Database with pgvector extension
  postgres:
    container_name: postgres
    image: pgvector/pgvector:pg17
    restart: unless-stopped
    ports:
      - "5432:5432"
    volumes:
      - ./packages/server/src/drizzle/0000_romantic_outlaw_kid.sql:/docker-entrypoint-initdb.d/0000_romantic_outlaw_kid.sql:ro
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      POSTGRES_DB: postgres
      POSTGRES_INITDB_ARGS: "-E UTF8"
    command:
      - "postgres"
      - "-c"
      - "shared_preload_libraries=vector"
      # - "-c"
      # - "max_connections=100" # Default is 100, adjust as needed
      # - "-c"
      # - "shared_buffers=128MB" # Default is 128MB, adjust as needed
    networks:
      - database_network

  # Redis Cache for local development
  redis:
    container_name: redis
    image: redis:7.2.11-alpine
    restart: unless-stopped
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - database_network

  # MinIO - S3-compatible object storage for local development
  minio:
    container_name: minio
    image: minio/minio:RELEASE.2025-07-23T15-54-02Z
    restart: unless-stopped
    ports:
      - "9000:9000"  # API port
      - "9001:9001"  # Console port
    volumes:
      - minio-data:/data
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - database_network

  # Document processor - Convert various files to Markdown
  document-processor:
    container_name: document-processor
    build:
      context: .
      dockerfile: apps/document-processor/Dockerfile
    restart: unless-stopped
    ports:
      - "3006:8080"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    environment:
      PORT: 8080
      ENVIRONMENT: development
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      DATABASE_HOST: localhost:5432
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}

      USE_LOCAL_FILE_STORAGE: ${USE_LOCAL_FILE_STORAGE}
      USE_CLOUDFLARE_R2: ${USE_CLOUDFLARE_R2}
      USE_OPENAI_API: ${USE_OPENAI_API}
      OPENAI_API_KEY: ${OPENAI_API_KEY}

      # Local MinIO configuration
      MINIO_ENDPOINT: localhost:9000
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}

      # Cloudflare R2 configuration
      R2_ENDPOINT: ${R2_ENDPOINT}
      CLOUDFLARE_ACCESS_KEY_ID: ${CLOUDFLARE_ACCESS_KEY_ID}
      CLOUDFLARE_SECRET_ACCESS_KEY: ${CLOUDFLARE_SECRET_ACCESS_KEY}

      EMBEDDINGS_MODEL: ${EMBEDDINGS_MODEL}

      CLOUD_PROVIDER: ${CLOUD_PROVIDER}

      # Gcloud configuration
      GOOGLE_VERTEX_PROJECT: ${GOOGLE_VERTEX_PROJECT}
      GOOGLE_VERTEX_LOCATION: ${GOOGLE_VERTEX_LOCATION}

      # Aws configuration
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION}
    networks:
      - database_network

  # The services below need not be run in Docker
  # It is better to run them using `pnpm run dev` due to hot-reloading

  # Custom API Service
  api:
    container_name: api
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    restart: unless-stopped
    ports:
      - "3004:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--spider",
          "http://localhost:8080/api/public/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    environment:
      PORT: 8080
      NODE_ENV: development

      BASE_URL: http://localhost:3000
      ALLOWED_ORIGINS: "http://localhost:3000,http://localhost:3001"

      # Document processor
      DOCUMENT_PROCESSOR_URL: http://localhost:3006

      # Better Auth configuration and Resend email service (for sending verification emails)
      BETTER_AUTH_URL: http://localhost:3004
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
      ENABLE_EMAIL_SIGNUP: ${ENABLE_EMAIL_SIGNUP}
      ALLOWED_EMAIL_DOMAINS: ${ALLOWED_EMAIL_DOMAINS}
      RESEND_SENDER_EMAIL: ${RESEND_SENDER_EMAIL}
      RESEND_API_KEY: ${RESEND_API_KEY}

      # Google OAuth
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}

      # Database and Redis
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      DATABASE_HOST: localhost:5432
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      REDIS_URL: "redis://localhost:6379" # Has format: redis://HOST:PORT

      USE_LOCAL_FILE_STORAGE: ${USE_LOCAL_FILE_STORAGE}
      USE_CLOUDFLARE_R2: ${USE_CLOUDFLARE_R2}
      USE_LOCAL_TASKS_CLIENT: ${USE_LOCAL_TASKS_CLIENT}
      USE_OPENAI_API: ${USE_OPENAI_API}
      OPENAI_API_KEY: ${OPENAI_API_KEY}

      # Local MinIO configuration
      MINIO_ENDPOINT: localhost:9000
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}

      # Cloudflare R2 configuration
      R2_ENDPOINT: ${R2_ENDPOINT}
      CLOUDFLARE_ACCESS_KEY_ID: ${CLOUDFLARE_ACCESS_KEY_ID}
      CLOUDFLARE_SECRET_ACCESS_KEY: ${CLOUDFLARE_SECRET_ACCESS_KEY}

      CLOUD_PROVIDER: ${CLOUD_PROVIDER}

      # Gcloud configuration
      GOOGLE_VERTEX_PROJECT: ${GOOGLE_VERTEX_PROJECT}
      GOOGLE_VERTEX_LOCATION: ${GOOGLE_VERTEX_LOCATION}
      CLOUD_TASKS_SA: ${CLOUD_TASKS_SA}
      TASK_QUEUE_PATH: ${TASK_QUEUE_PATH}

      # Aws configuration
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION}
      SQS_QUEUE_URL: ${SQS_QUEUE_URL}

      # Configuration common to all cloud providers
      ATTACHMENT_URL_PREFIX: ${ATTACHMENT_URL_PREFIX}
      EMBEDDINGS_MODEL: ${EMBEDDINGS_MODEL}
      LLM_MODELS: ${LLM_MODELS}
    networks:
      - database_network

  # PDF Exporter Service
  pdf-exporter:
    container_name: pdf-exporter
    build:
      context: .
      dockerfile: apps/pdf-exporter/Dockerfile
    restart: unless-stopped
    ports:
      - "3005:8080"
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--spider",
          "http://localhost:8080/pdf-exporter/public/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    environment:
      PORT: 8080
      NODE_ENV: development
      ALLOWED_ORIGINS: "http://localhost:3000,http://localhost:3001"
    networks:
      - database_network

  # Web interface (Next.js)
  web:
    container_name: web
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        NEXT_PUBLIC_BASE_URL: http://localhost:3000
        NEXT_PUBLIC_DASHBOARD_URL: http://localhost:3001
        NEXT_PUBLIC_API_URL: http://localhost:3004
        NEXT_PUBLIC_PDF_EXPORTER_URL: http://localhost:3005
        NEXT_PUBLIC_CSP_ENDPOINTS: ${NEXT_PUBLIC_CSP_ENDPOINTS}
    restart: unless-stopped
    ports:
      - "3000:3000"

  # Dashboard interface (Next.js)
  dashboard:
    container_name: dashboard
    build:
      context: .
      dockerfile: apps/dashboard/Dockerfile
      args:
        NEXT_PUBLIC_BASE_URL: http://localhost:3001
        NEXT_PUBLIC_CHAT_URL: http://localhost:3000
        NEXT_PUBLIC_API_URL: http://localhost:3004
        NEXT_PUBLIC_PDF_EXPORTER_URL: http://localhost:3005
        NEXT_PUBLIC_CSP_ENDPOINTS: ${NEXT_PUBLIC_CSP_ENDPOINTS}
    restart: unless-stopped
    ports:
      - "3001:3000"

volumes:
  postgres-data:
  redis-data:
  minio-data:

networks:
  database_network:
    driver: bridge
